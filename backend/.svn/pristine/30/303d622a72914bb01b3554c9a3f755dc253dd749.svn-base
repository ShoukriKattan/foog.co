var moment = require('cloud/moment-timezone-with-data.js');

var REMINDER_DAYS_COACH_HAS_LINKS = 5;

var MEAL_REVIEW_REMINDER_DAYS = 3;

var SUMMARY_SET_REMINDER_DAYS = 4;

var NO_MEALS_SUBMITTED_REMINDER_DAYS = 1;

var remindCoachUserLinks = function() {

	var today = moment();
	var xDaysAgo = today.clone().subtract(REMINDER_DAYS_COACH_HAS_LINKS, 'days');

	var CoachUserLink = Parse.Object.extend("CoachUserLink");

	//Not linked, not rejected, not cancelled, last reminder x days ago.
	var remindedBeforeXDays = new Parse.Query(CoachUserLink);
	remindedBeforeXDays.doesNotExist('linkedAt');
	remindedBeforeXDays.doesNotExist('rejectedAt');
	remindedBeforeXDays.doesNotExist('cancelledAt');
	remindedBeforeXDays.lessThan('remindedAt', xDaysAgo.toDate);

	return remindedBeforeXDays.find().then(function(coachUserLinks) {

		var promises = new Array();

		for (var i = 0; i < coachUserLinks.length; i++) {

			// Simple ... set a date and save.

			var link = coachUserLinks[i];
			link.set('remindedAt', new Date());
			promise = link.save();

			promises.push(promise);
		}
		return Parse.Promise.when(promises);
	});

};

var remindNonReviewedMeals = function() {

	var today = moment();
	var xDaysAgo = today.clone().subtract(MEAL_REVIEW_REMINDER_DAYS, 'days');

	var Meal = Parse.Object.extend("Meal");

	// Try to find meals , which are old, but have no date Reviewed.
	var remindedBeforeXDays = new Parse.Query(Meal);
	remindedBeforeXDays.doesNotExist('coachReviewedAt');
	// Coach has not reviewed them.
	remindedBeforeXDays.doesNotExist('summaryCreatedAt');
	// No summary created for them.
	remindedBeforeXDays.lessThan('appCreatedAt', xDaysAgo.toDate);
	// Created before x days
	//TODO: take reminded at into account as well. Dont remind every day... ... 

	return remindedBeforeXDays.find().then(function(meals) {

		// Send a general reminder, that coach has not reviewed meals.
		// Depending on who the coach is

		var promises = new Array();

		for (var i = 0; i < meals.length; i++) {

			// Simple ... set a date and save.

			var meal = meals[i];
			meal.set('coachRemindedAt', new Date());
			promise = meal.save();

			promises.push(promise);
		}
		return Parse.Promise.when(promises);
	});

};

var remindUserNoMealsSubmitted = function() {

	// For all fucking users. for each user, check last meal submitted date time.

	var today = moment();
	var xDaysAgo = today.clone().subtract(NO_MEALS_SUBMITTED_REMINDER_DAYS, 'days');

	var ClientInfo = Parse.Object.extend("ClientInfo");
	var clientInfoQuery = new Parse.Query(ClientInfo);

	// All ClientInfo where last reminded is x days ago.
	return query.find().then(function(clientInfoResults) {

		// See last date of meals .. and notify immediately.. or if meals are ok, then ... also set remindedAt
		var promises = new Array();

		for (var i = 0; i < clientInfoResults.length; i++) {

			var clientInfo1 = clientInfoResults[i];

			var user = clientInfo1.get("user");
			var coach = clientInfo1.get("coach");

			// Try to find one meal that has been created after x days ago. if there is one ... good
			var query = new Parse.Query("Meal");
			query.equalTo("user", user);
			query.equalTo("coach", coach);
			query.doesNotExist("summaryCreatedAt");
			query.greaterThanOrEqualTo("appCreatedAt", xDaysAgo.toDate());
			query.ascending("appCreatedAt");

			var promise = query.first().then(function(theMeal) {

				if (!theMeal) {
					// return notify
					clientInfo1.set("mealReminderDate", new Date());
					return clientInfo1.save();
				} else {
					return Parse.Promise.as('UserIsSubmittingMeals');
				}

			});

			promises.push(promise);

		}

		return Parse.Promise.when(promises);

	});

};

exports.runReminders = function() {

	// Once we remind, we need to save new date....

	var promises = new Array();
	promises.push(remindCoachUserLinks());
	promises.push(remindNonReviewedMeals());
	promises.push(remindUserNoMealsSubmitted());

	return Parse.Promise.when(promises);
};
