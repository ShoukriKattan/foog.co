var Notifications = require("cloud/notifications.js");
var utils = require("cloud/utils.js");

var beforeSaveMeal = function(request, response) {

	request.object.set("changedFields", request.object.dirtyKeys());

	response.success();

};

var afterSaveMeal = function(request) {

	var meal = request.object;

	console.log("changedFields:" + JSON.stringify(meal.get("changedFields")));

	var changedFields = meal.get("changedFields");

	var user = meal.get("user");
	var coach = meal.get("coach");

	if (user && coach) {

		// Based on changed fields .. Decide what to notify about;

		var notificationType = null;

		if (utils.fieldChanged(changedFields, "coachCommentedAt")) {

			notificationType = Notifications.NOTIFICATION_TYPE_COACH_COMMENTED;

		} else if (utils.fieldChanged(changedFields, "userCommentedAt")) {

			notificationType = Notifications.NOTIFICATION_TYPE_USER_COMMENTED;

		} else if (utils.fieldChanged(changedFields, "coachReviewedAt")) {

			notificationType = Notifications.NOTIFICATION_TYPE_COACH_REVIEWED_MEAL;

		} else if (utils.fieldChanged(changedFields, "appCreatedAt")) {

			notificationType = Notifications.NOTIFICATION_TYPE_NEW_MEAL;

		}

		if (notificationType) {
			Notifications.sendNotification(user, notificationType, user, coach, meal);
		}

	} else {
		// Ignore
	}

};

var beforeSaveUser = function(request, response) {

	//TODO: Revise this code...
	// Hold CoachID

	var coachId = request.object.get("coachId");

	console.log("Coach ID coming back " + coachId);

	var objectId = request.object.id;

	// Make sure this call is to register new Coach.
	if (coachId && !objectId) {
		// Make sure that CoachID is not already taken.
		var query = new Parse.Query("User");
		query.equalTo("coachId", coachId);
		query.first({
			success : function(object) {
				if (object) {
					response.error("CoachIdIsTaken");
				} else {
					response.success();
				}
			},
			error : function(error) {
				response.error("Could not validate uniqueness CoachID");
			}
		});
	} else {
		response.success();
	}
};

var beforeSaveCoachUserLink = function(request, response) {

	request.object.set("changedFields", request.object.dirtyKeys());

	//TODO: Revise this code.
	// Hold CoachID
	var coachId = request.object.get("coachId");

	console.log("Coach ID sent before save coachUserLink " + coachId);
	if (!coachId) {
		response.success();
		return;
	}
	//TODO: Add Coach to User Table.
	// Find Coach User object with provided CoachID.
	var query = new Parse.Query(Parse.User);
	query.equalTo("coachId", coachId);
	query.first({
		success : function(coach) {
			if (coach) {
				// Replace CoachID within CoachUserLink with Coach User object.
				request.object.unset("coachId");
				request.object.set("coach", coach);

				response.success();
			} else {
				response.error("CoachNotFound");
			}
		},
		error : function(error) {
			response.error("QueryError");
		}
	});

};

//TODO: This is crap ... this needs further testing ... I have no idea what the fuck is the logic here...
var afterSaveCoachUserLink = function(request) {

	//Validate if this is a new user link and not an update...

	var coachUserLink = request.object;

	var changedFields = coachUserLink.get("changedFields");

	var terminatedBy = coachUserLink.get("terminatedBy");
	var coach = coachUserLink.get("coach");
	var user = coachUserLink.get("user");

	// User and Coach need both be set
	if (user && coach) {

		if (utils.fieldChanged(changedFields, "linkedAt")) {
			// New LINK

			//TODO: Modify here .... Load user .. and save Coach to User Linking ...
			// Get the user...
			var userQuery = new Parse.Query(Parse.User);

			
			userQuery.get(user.id).then(function(theUser) {

				theUser.set("coach", coach);

				return theUser.save();
			}).then(function() {

				Notifications.sendNotification(user, Notifications.NOTIFICATION_TYPE_COACH_ACCEPTED_LINK_REQUEST, user, coach);

			}, function(error) {
				console.error("Shit Happened here ... Object Not Found??" + JSON.stringify(error));
			});

			return;

		} else if (utils.fieldChanged(changedFields, "rejectedAt")) {

			// Coach rejected linking request ... Oh no !
			// User needs to be notified
			Notifications.sendNotification(user, Notifications.NOTIFICATION_TYPE_COACH_REJECTED_LINK_REQUEST, user, coach);

		} else if (utils.fieldChanged(changedFields, "cancelledAt")) {
			// User got bored of waiting and decided to cancel.
			// Coach needs to be notified
			Notifications.sendNotification(coach, Notifications.NOTIFICATION_TYPE_USER_CANCELLED_LINK_REQUEST, user, coach);

		} else if (utils.fieldChanged(changedFields, "terminatedAt")) {

			//TODO: Modify here .... Load user .. and save Coach to User Linking ...
			// Get the user...
			var userQuery = new Parse.Query(Parse.User);

			userQuery.get(user.id).then(function(theUser) {

				theUser.unset("coach");

				return theUser.save();
			}).then(function() {

				if (terminatedBy == user) {
					Notifications.sendNotification(coach, Notifications.NOTIFICATION_TYPE_USER_UNLINKED, user, coach);
				} else {
					Notifications.sendNotification(user, Notifications.NOTIFICATION_TYPE_COACH_UNLINKED, user, coach);
				}

			}, function(error) {
				console.error(JSON.stringify(error));
			});

		} else {

			console.log("Fields Changed in this case " + JSON.stringify(changedFields));
			// if not linked nor rejected, this is a new request.
			// Coach needs to be notified
			Notifications.sendNotification(coach, Notifications.NOTIFICATION_TYPE_USER_SENT_LINK_REQUEST, user, coach);

			return;

		}

	} else {

		console.error("Coach user link added but no user and coach ");
	}

};

var afterSaveSummaryCard = function(request) {

	var summaryCard = request.object;

	var user = summaryCard.get("user");
	var coach = summaryCard.get("coach");

	var summaryCreatedAt = summaryCard.get("summaryCreatedAt");

	// No need to be fancy .. If Summary Created At is set, this means this is a complete summary Card... No Fancy Shmancy .
	// When they update summary cards. no one but batch touch summary Created At date..
	if (summaryCreatedAt) {

		// Notify user and Notify Coach

		Notifications.sendNotification(user, Notifications.NOTIFICATION_TYPE_SUMMARY_AVAIALABLE_TO_USER, user, coach, null, summaryCard).then(function() {

			Notifications.sendNotification(coach, Notifications.NOTIFICATION_TYPE_SUMMARY_AVAILABLE_TO_COACH, user, coach, null, summaryCard);

		});

	}

};

exports.afterSaveMeal = afterSaveMeal;
exports.afterSaveSummaryCard = afterSaveSummaryCard;
exports.beforeSaveUser = beforeSaveUser;
exports.beforeSaveCoachUserLink = beforeSaveCoachUserLink;
exports.afterSaveCoachUserLink = afterSaveCoachUserLink;
exports.beforeSaveMeal = beforeSaveMeal;
